
#Область ОбработчикиМетодовHTTP

Функция EventsCallPOST(Запрос)
	
	ЛогироватьВЖурналПроксированиеЗапросов(".anonimazer.events.call", Запрос);
	
	Возврат ПроксироватьHTTPЗапрос(Запрос, Метаданные.HTTPСервисы.TelephonyApi.ШаблоныURL.EventsCall.Шаблон);
	
КонецФункции

Функция EventsRecordingPOST(Запрос)
	
	ЛогироватьВЖурналПроксированиеЗапросов(".anonimazer.events.recording", Запрос);
	
	Возврат ПроксироватьHTTPЗапрос(Запрос, Метаданные.HTTPСервисы.TelephonyApi.ШаблоныURL.EventsRecording.Шаблон);
	
КонецФункции

Функция ResultCallbackPOST(Запрос)
	
	ЛогироватьВЖурналПроксированиеЗапросов(".anonimazer.result.callback",  Запрос);
	
	Возврат ПроксироватьHTTPЗапрос(Запрос, Метаданные.HTTPСервисы.TelephonyApi.ШаблоныURL.ResultCallback.Шаблон);
	
КонецФункции

Функция ResultRoutePOST(Запрос)
	
	ЛогироватьВЖурналПроксированиеЗапросов(".anonimazer.result.route",  Запрос);
	
	Возврат ПроксироватьHTTPЗапрос(Запрос, Метаданные.HTTPСервисы.TelephonyApi.ШаблоныURL.ResultRoute.Шаблон);
	
КонецФункции

Функция ResultStatsPOST(Запрос)
	
	ЛогироватьВЖурналПроксированиеЗапросов(".anonimazer.result.stats", Запрос);
	
	Возврат ПроксироватьHTTPЗапрос(Запрос, Метаданные.HTTPСервисы.TelephonyApi.ШаблоныURL.ResultStats.Шаблон);
	
КонецФункции

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

Функция ПроксироватьHTTPЗапрос(ВходящийHTTPЗапрос, Шаблон)
	
	ОбщиеНастройкиТелефонии = УдалитьПроксированиеЗапросов.ПолучитьОбщиеНастройкиТелефонии(); 
	Если НЕ ОбщиеНастройкиТелефонии.Свойство("ИмяСервераОсновнойПубликации")
		ИЛИ НЕ ОбщиеНастройкиТелефонии.Свойство("АдресРесурсаОсновнойПубликации")
		ИЛИ НЕ ОбщиеНастройкиТелефонии.Свойство("НомерПортаОсновнойПубликации")
		Тогда
		
		Возврат Новый HTTPСервисОтвет(502, НСтр("Not specified the proxy settings http-requests."));
		
	КонецЕсли;
	
	ЗащищенноеСоединение = Неопределено;
	Если СтрНайти(ВходящийHTTPЗапрос.БазовыйURL, "https") > 0 Тогда
		
		ЗащищенноеСоединение = Новый ЗащищенноеСоединениеOpenSSL;
		
	КонецЕсли;
	
	Попытка
		
		Соединение = Новый HTTPСоединение(ОбщиеНастройкиТелефонии.ИмяСервераОсновнойПубликации, ОбщиеНастройкиТелефонии.НомерПортаОсновнойПубликации,,,,, ЗащищенноеСоединение,);
		
	Исключение
		
		Возврат Новый HTTPСервисОтвет(502);
		
	КонецПопытки;
	
	ПараметрыПроксирования = Новый Структура;
	ПараметрыПроксирования.Вставить("AddressResource", ОбщиеНастройкиТелефонии.АдресРесурсаОсновнойПубликации);
	ПараметрыПроксирования.Вставить("NumberZone", ВходящийHTTPЗапрос.ПараметрыURL["NumberZone"]);
	ПараметрыПроксирования.Вставить("RootURL", Метаданные.HTTPСервисы.TelephonyApi.КорневойURL);
	ПараметрыПроксирования.Вставить("Pattern", Метаданные.HTTPСервисы.TelephonyApi.ШаблоныURL.EventsCall.Шаблон);
	
	ИсходящийHTTPЗапрос = Новый HTTPЗапрос;
	ИсходящийHTTPЗапрос.АдресРесурса = СтроковыеФункцииКлиентСервер.ВставитьПараметрыВСтроку("/[AddressResource]/[NumberZone]/hs/[RootURL][Pattern]", ПараметрыПроксирования);
	
	Для каждого Заголовок Из ВходящийHTTPЗапрос.Заголовки Цикл
		
		Если Заголовок.Ключ = "Host" Тогда
			
			ИсходящийHTTPЗапрос.Заголовки.Вставить(Заголовок.Ключ, ОбщиеНастройкиТелефонии.ИмяСервераОсновнойПубликации);
			
		Иначе
			
			ИсходящийHTTPЗапрос.Заголовки.Вставить(Заголовок.Ключ, Заголовок.Значение);
			
		КонецЕсли;
		
	КонецЦикла;
	ИсходящийHTTPЗапрос.Заголовки.Вставить("Authorization", "Basic " + УдалитьПроксированиеЗапросов.AuthorizationСлужебногоРазделенногоПользователяОблачнойТелефонии());
	
	ИсходящийHTTPЗапрос.УстановитьТелоИзСтроки(ВходящийHTTPЗапрос.ПолучитьТелоКакСтроку(), КодировкаТекста.UTF8);
	
	Попытка
		
		HTTPОтвет = Соединение.ОтправитьДляОбработки(ИсходящийHTTPЗапрос);
		
	Исключение
		
		Возврат Новый HTTPСервисОтвет(503);
		
	КонецПопытки;
	
	Возврат Новый HTTPСервисОтвет(HTTPОтвет.КодСостояния, , HTTPОтвет.Заголовки);
	
	//http://mango-integration-1c-d9-msk.1c.ru/MangoAnonimazer/hs/mango-anonimazer/events/call
	//http://mango-integration-1c-d9-msk.1c.ru/phoneSBM_1/3/hs/mango-api/events/call
	//https://mango-integration-gpt-msk.1c.ru/phoneSBM_1/3/hs/mango-api/events/call
	//TWFuZ29TZXJ2aWNlOmFlNzFmMjE1LTJkNzQtNDUyOC1iZTRmLWYyOTkyM2I4ZjNkZA==
	
КонецФункции

Процедура ЛогироватьВЖурналПроксированиеЗапросов(ИмяСобытия, Запрос)
	
	ОбщиеНастройкиТелефонии = УдалитьПроксированиеЗапросов.ПолучитьОбщиеНастройкиТелефонии(); 
	
	Если ОбщиеНастройкиТелефонии.Свойство("ЛогироватьВЖурналПроксированиеЗапросов")
		И ОбщиеНастройкиТелефонии.ЛогироватьВЖурналПроксированиеЗапросов = Истина Тогда
		
		ИмяСобытия		= ТелефонияСервер.СобытиеЖурналаРегистрации() + ИмяСобытия;
		ШаблонОписания	= УдалитьПроксированиеЗапросов.ШаблонОписанияHTTPЗапроса();
		БазовыйURL		= Запрос.БазовыйURL;
		ТелоHTTPЗапроса = Запрос.ПолучитьТелоКакСтроку();
		
		ОписаниеHTTPЗапроса = СтрШаблон(ШаблонОписания, БазовыйURL, "POST", ТелоHTTPЗапроса);
		
		ЗаписьЖурналаРегистрации(ИмяСобытия, УровеньЖурналаРегистрации.Информация, Метаданные.HTTPСервисы.УдалитьTelephonyAnonimizer,,
			ОписаниеHTTPЗапроса);
		
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти
